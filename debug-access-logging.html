<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Debug LogAccess</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .test-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug - Registro de Accesos</h1>
        <p>Esta p√°gina ayuda a diagnosticar por qu√© no se registran los accesos.</p>
        
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107;">
            <h4>üìã Instrucciones de Diagn√≥stico:</h4>
            <ol>
                <li><strong>Paso 1:</strong> Haz clic en "0. Inspeccionar tabla BD" para verificar el estado de la tabla</li>
                <li><strong>Paso 2:</strong> Haz clic en "1. Test funci√≥n logAccess" para probar la inserci√≥n directa</li>
                <li><strong>Paso 3:</strong> Haz clic en "2. Test login completo" para simular un login real</li>
                <li><strong>Paso 4:</strong> Haz clic en "3. Verificar historial actual" para ver los resultados</li>
                <li><strong>Resultado esperado:</strong> Deber√≠as ver registros insertados en cada paso</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üß™ Tests Disponibles</h3>
            <button onclick="inspectAccessLogsTable()">0. Inspeccionar tabla BD</button>
            <button onclick="testLogAccessFunction()">1. Test funci√≥n logAccess</button>
            <button onclick="testLogin()">2. Test login completo</button>
            <button onclick="checkAccessHistory()">3. Verificar historial actual</button>
            <button onclick="clearResults()">üóëÔ∏è Limpiar resultados</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Inspeccionar tabla de base de datos directamente
        async function inspectAccessLogsTable() {
            try {
                showResult('üîç Inspeccionando tabla access_logs en la base de datos...', 'info');
                
                const response = await fetch('/.netlify/functions/inspect-access-logs', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const inspection = data.inspection;
                    let resultHtml = '<h3>üîç Inspecci√≥n de Tabla access_logs</h3>';
                    
                    resultHtml += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">`;
                    resultHtml += `<h4>üìä Estad√≠sticas:</h4>`;
                    resultHtml += `<p><strong>Total de registros:</strong> ${inspection.totalRecords}</p>`;
                    resultHtml += `<p><strong>Registros √∫ltimas 24h:</strong> ${inspection.recentRecords}</p>`;
                    resultHtml += `<p><strong>Registros del admin:</strong> ${inspection.adminRecords}</p>`;
                    resultHtml += `<p><strong>Timestamp inspecci√≥n:</strong> ${inspection.timestamp}</p>`;
                    resultHtml += `</div>`;
                    
                    if (inspection.structure && inspection.structure.length > 0) {
                        resultHtml += '<h4>üèóÔ∏è Estructura de la tabla:</h4>';
                        resultHtml += '<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">';
                        resultHtml += '<tr style="background: #e9ecef;"><th style="border: 1px solid #ddd; padding: 8px;">Columna</th><th style="border: 1px solid #ddd; padding: 8px;">Tipo</th><th style="border: 1px solid #ddd; padding: 8px;">Nullable</th></tr>';
                        inspection.structure.forEach(col => {
                            resultHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">${col.column_name}</td><td style="border: 1px solid #ddd; padding: 8px;">${col.data_type}</td><td style="border: 1px solid #ddd; padding: 8px;">${col.is_nullable}</td></tr>`;
                        });
                        resultHtml += '</table>';
                    }
                    
                    if (inspection.lastRecords && inspection.lastRecords.length > 0) {
                        resultHtml += '<h4>üìã √öltimos registros RAW de la BD:</h4>';
                        inspection.lastRecords.forEach((record, index) => {
                            resultHtml += `<div style="background: #f1f3f4; padding: 10px; margin: 5px 0; border-radius: 3px; font-family: monospace; font-size: 12px;">`;
                            resultHtml += `<strong>Registro ${index + 1}:</strong><br>`;
                            resultHtml += `<pre>${JSON.stringify(record, null, 2)}</pre>`;
                            resultHtml += `</div>`;
                        });
                    } else {
                        resultHtml += '<p style="color: red; font-weight: bold;">‚ö†Ô∏è NO HAY REGISTROS EN LA TABLA</p>';
                        resultHtml += '<p>Esto confirma que la funci√≥n logAccess no est√° insertando datos.</p>';
                    }
                    
                    showResult(resultHtml, inspection.totalRecords > 0 ? 'success' : 'error');
                } else {
                    showResult(`‚ùå Error en inspecci√≥n: ${data.error}<br>Detalles: ${data.details || 'N/A'}`, 'error');
                    if (data.stack) {
                        showResult(`<pre>${data.stack}</pre>`, 'error');
                    }
                }
            } catch (error) {
                showResult(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Test directo de la funci√≥n logAccess
        async function testLogAccessFunction() {
            try {
                showResult('üîÑ Probando funci√≥n logAccess directamente...', 'info');
                
                const response = await fetch('/.netlify/functions/test-logaccess', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    let resultHtml = '<h3>‚úÖ Test de logAccess exitoso</h3>';
                    resultHtml += `<p><strong>Mensaje:</strong> ${data.message}</p>`;
                    resultHtml += `<p><strong>Timestamp:</strong> ${data.timestamp}</p>`;
                    
                    if (data.lastEntry) {
                        resultHtml += '<h4>√öltimo registro insertado:</h4>';
                        resultHtml += `<pre>${JSON.stringify(data.lastEntry, null, 2)}</pre>`;
                    } else {
                        resultHtml += '<p><strong>‚ö†Ô∏è No se encontr√≥ el registro insertado</strong></p>';
                    }
                    
                    showResult(resultHtml, 'success');
                } else {
                    showResult(`‚ùå Error en test: ${data.error}<br>Detalles: ${data.details || 'N/A'}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Test de login completo
        async function testLogin() {
            try {
                showResult('üîÑ Probando login completo con credenciales de prueba...', 'info');
                
                const response = await fetch('/.netlify/functions/auth-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@zaro.com',
                        password: 'admin123'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    let resultHtml = '<h3>‚úÖ Login exitoso</h3>';
                    
                    if (data.requiresSetup2FA) {
                        resultHtml += '<p><strong>Estado:</strong> Requiere configuraci√≥n 2FA</p>';
                        localStorage.setItem('tempToken', data.tempToken);
                    } else if (data.requiresTwoFactor) {
                        resultHtml += '<p><strong>Estado:</strong> Requiere verificaci√≥n 2FA</p>';
                        localStorage.setItem('tempToken', data.tempToken);
                    } else {
                        resultHtml += '<p><strong>Estado:</strong> Login completo</p>';
                        localStorage.setItem('authToken', data.token);
                    }
                    
                    resultHtml += '<p><em>Ahora verifica el historial para ver si se registr√≥ este acceso.</em></p>';
                    showResult(resultHtml, 'success');
                } else {
                    showResult(`‚ùå Error en login: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Verificar historial actual
        async function checkAccessHistory() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                showResult('‚ö†Ô∏è No hay token de autenticaci√≥n. Haz login primero.', 'error');
                return;
            }

            try {
                showResult('üîÑ Obteniendo historial actual...', 'info');
                
                const response = await fetch('/.netlify/functions/access-history', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.accessHistory) {
                    let resultHtml = '<h3>üìã Historial Actual:</h3>';
                    
                    if (data.accessHistory.length === 0) {
                        resultHtml += '<p><strong>‚ö†Ô∏è No hay registros de acceso.</strong></p>';
                        resultHtml += '<p>Esto confirma que no se est√°n registrando los accesos correctamente.</p>';
                    } else {
                        resultHtml += `<p><strong>Total de registros:</strong> ${data.accessHistory.length}</p>`;
                        resultHtml += '<h4>√öltimos 3 registros:</h4>';
                        
                        data.accessHistory.slice(0, 3).forEach((log, index) => {
                            resultHtml += `
                                <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px;">
                                    <strong>Registro ${index + 1}:</strong><br>
                                    Fecha: ${log.date}<br>
                                    Dispositivo: ${log.device}<br>
                                    IP: ${log.ip}<br>
                                    Estado: ${log.status}<br>
                                    2FA: ${log.twoFactorUsed ? 'S√≠' : 'No'}
                                </div>
                            `;
                        });
                    }
                    
                    showResult(resultHtml, 'info');
                } else {
                    showResult(`‚ùå Error obteniendo historial: ${data.error || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        function showResult(message, type) {
            const resultsDiv = document.getElementById('results');
            const resultElement = document.createElement('div');
            resultElement.className = `status ${type}`;
            resultElement.innerHTML = message;
            resultsDiv.appendChild(resultElement);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Mostrar informaci√≥n inicial
        showResult('üîç Sistema de debug inicializado. Usa los botones para diagnosticar problemas.', 'info');
    </script>
</body>
</html>
